<!DOCTYPE html>
<html>
<head>
  <title>My Cloud Storage</title>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
      color: #333;
    }
    input, button {
      padding: 10px;
      margin: 5px;
    }
    #file-list img, #file-list video {
      max-width: 200px;
      max-height: 150px;
      margin: 10px;
      display: block;
    }
    .file-item {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
      background: white;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<h2>üóÇÔ∏è My Cloud Storage</h2>

<div id="auth-section">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Signup</button>
</div>

<div id="main-section" class="hidden">
  <p>Welcome, <span id="user-email"></span>! <button onclick="logout()">Logout</button></p>
  <input type="file" id="fileInput" />
  <button onclick="uploadFile()">Upload</button>

  <h3>Your Files:</h3>
  <div id="file-list"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const SUPABASE_URL = "https://sgtfjntptdxgrcqkftn.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNndGZqbnRwdGR4Z3JjcXFrZnRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyNDE3NzksImV4cCI6MjA2NjgxNzc3OX0.6u77xHcSVwShF2YDtaPMuo9NIw035v8QczoNAqqDVVk";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const authSection = document.getElementById("auth-section");
  const mainSection = document.getElementById("main-section");
  const userEmailSpan = document.getElementById("user-email");
  const fileList = document.getElementById("file-list");

  async function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) alert("Login failed: " + error.message);
    else location.reload();
  }

  async function signup() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) alert("Signup failed: " + error.message);
    else alert("Check your email to confirm signup.");
  }

  async function logout() {
    await supabase.auth.signOut();
    location.reload();
  }

  async function uploadFile() {
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];
    if (!file) return alert("No file selected.");

    const user = (await supabase.auth.getUser()).data.user;
    const filePath = `${user.id}/${Date.now()}_${file.name}`;
    
    const { error: uploadError } = await supabase.storage.from('uploads').upload(filePath, file);
    if (uploadError) return alert("Upload failed: " + uploadError.message);

    const { data: publicURL } = supabase.storage.from('uploads').getPublicUrl(filePath);
    await supabase.from('files').insert({
      user_id: user.id,
      filename: file.name,
      url: publicURL.publicUrl
    });
    
    fileInput.value = "";
    loadFiles();
  }

  async function loadFiles() {
    const user = (await supabase.auth.getUser()).data.user;
    const { data, error } = await supabase.from('files').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
    if (error) return alert("Error loading files: " + error.message);
    
    fileList.innerHTML = "";
    for (const file of data) {
      const fileItem = document.createElement("div");
      fileItem.className = "file-item";

      const isImage = file.url.match(/\.(jpeg|jpg|png|gif)$/i);
      const isVideo = file.url.match(/\.(mp4|webm|ogg)$/i);

      if (isImage) {
        const img = document.createElement("img");
        img.src = file.url;
        fileItem.appendChild(img);
      } else if (isVideo) {
        const video = document.createElement("video");
        video.src = file.url;
        video.controls = true;
        fileItem.appendChild(video);
      }

      const name = document.createElement("p");
      name.textContent = file.filename;
      fileItem.appendChild(name);

      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.onclick = async () => {
        const pathParts = file.url.split("/uploads/")[1];
        await supabase.storage.from("uploads").remove([pathParts]);
        await supabase.from("files").delete().eq("id", file.id);
        loadFiles();
      };
      fileItem.appendChild(delBtn);

      fileList.appendChild(fileItem);
    }
  }

  supabase.auth.onAuthStateChange(async (event, session) => {
    if (session && session.user) {
      authSection.classList.add("hidden");
      mainSection.classList.remove("hidden");
      userEmailSpan.textContent = session.user.email;
      loadFiles();
    } else {
      authSection.classList.remove("hidden");
      mainSection.classList.add("hidden");
    }
  });

  // Load current user session
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session && session.user) {
      authSection.classList.add("hidden");
      mainSection.classList.remove("hidden");
      userEmailSpan.textContent = session.user.email;
      loadFiles();
    }
  })();
</script>
</body>
</html>