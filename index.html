<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My CloudStorage</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #eef2f5;
      min-height: 100vh;
      padding: 1rem;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    header h2 {
      font-size: 1.25rem;
      color: #4a90e2;
    }
    header button {
      background: #e24a4a;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    #uploader {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    #uploader input[type="file"] {
      flex: 1;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #uploader button {
      background: #50e3c2;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    #uploader button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #file-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
    }
    .file-item {
      background: #fff;
      border-radius: 8px;
      padding: 0.75rem;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .file-item img, .file-item video {
      width: 100%;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }
    .file-item button {
      margin-top: auto;
      background: #e24a4a;
      color: #fff;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <header>
    <h2>☁️ CloudStorage</h2>
    <button id="logoutBtn">Logout</button>
  </header>

  <div id="uploader">
    <input type="file" id="fileInput" />
    <button id="uploadBtn" disabled>Upload</button>
  </div>

  <div id="file-list"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const { createClient } = supabase;
    const sb = createClient(
      "https://sgtfjntptdxgrcqqkftn.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…"
    );

    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const fileList = document.getElementById('file-list');

    // enable upload button only when a file is selected
    fileInput.onchange = () => {
      uploadBtn.disabled = !fileInput.files.length;
    };

    logoutBtn.onclick = async () => {
      await sb.auth.signOut();
      location.replace('/cloudstorage/login');
    };

    async function redirectIfNotLoggedIn() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) location.replace('/cloudstorage/login');
      return session?.user;
    }

    async function uploadFile() {
      const file = fileInput.files[0];
      uploadBtn.disabled = true;
      const user = (await sb.auth.getUser()).data.user;
      const path = `${user.id}/${Date.now()}_${file.name}`;

      const { error: upErr } = await sb.storage.from('uploads').upload(path, file);
      if (upErr) return alert('Upload error: '+upErr.message);

      await sb.from('files').insert({
        user_id: user.id,
        filename: file.name,
        url: sb.storage.from('uploads').getPublicUrl(path).data.publicUrl
      });

      fileInput.value = '';
      loadFiles();
    }

    async function loadFiles() {
      fileList.innerHTML = '';
      const user = (await sb.auth.getUser()).data.user;
      const { data: files } = await sb
        .from('files')
        .select('id,filename,url')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (!files.length) {
        fileList.innerHTML = '<p>No files yet.</p>';
        return;
      }

      for (const f of files) {
        const div = document.createElement('div');
        div.className = 'file-item';

        if (/\.(jpe?g|png|gif)$/i.test(f.url)) {
          const img = document.createElement('img');
          img.src = f.url;
          div.appendChild(img);
        } else if (/\.(mp4|webm)$/i.test(f.url)) {
          const vid = document.createElement('video');
          vid.src = f.url;
          vid.controls = true;
          div.appendChild(vid);
        } else {
          const link = document.createElement('a');
          link.href = f.url;
          link.textContent = f.filename;
          link.target = '_blank';
          div.appendChild(link);
        }

        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.onclick = async () => {
          await sb.storage.from('uploads').remove([f.url.split('/uploads/')[1]]);
          await sb.from('files').delete().eq('id', f.id);
          loadFiles();
        };
        div.appendChild(del);

        fileList.appendChild(div);
      }
    }

    (async () => {
      await redirectIfNotLoggedIn();
      loadFiles();
    })();

    sb.auth.onAuthStateChange((_e, s) => {
      if (!s) location.replace('/cloudstorage/login');
    });

    uploadBtn.onclick = uploadFile;
  </script>
</body>
</html>