<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ByteCrate">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Githubuser102234/cloudstorage/refs/heads/main/maincdn/7E7BA7A7-E386-4897-A477-656535A9FAA7.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://raw.githubusercontent.com/Githubuser102234/bytecrate/refs/heads/main/maincdn/IMG_1393.jpeg" type="image/jpeg">
  <title>ByteCrate - Home</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    :root {
      --bg: #121212;
      --card: #1e1e1e;
      --accent: #0ea5e9;
      --text: #ffffff;
      --subtext: #cccccc;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      width: 100%;
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    h2 {
      margin-top: 0;
      color: var(--accent);
      text-align: center;
    }
    input, button {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
      font-size: 16px;
    }
    input {
      background: #2a2a2a;
      color: var(--text);
    }
    button {
      background: var(--accent);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #0284c7;
    }
    .file-item {
      margin-top: 20px;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 10px;
      word-break: break-word;
      position: relative;
    }
    .file-item img,
    .file-item video {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      margin-top: 10px;
      border-radius: 6px;
    }
    .file-item small a {
      color: var(--accent);
      word-break: break-all;
    }
    .delete-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #e55353;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
      margin: 0;
    }
    .delete-btn:hover {
      background: #c72e2e;
    }
    .rename-btn {
      position: absolute;
      top: 45px;
      right: 15px;
      background: #0ea5e9;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
      margin: 0;
    }
    .rename-btn:hover {
      background: #0284c7;
    }
    #auth-container {
      margin-bottom: 20px;
    }
    #logout-btn {
      background: #e55353;
      margin-top: 10px;
    }
    #logout-btn:hover {
      background: #c72e2e;
    }
    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }
      button {
        width: 100%;
      }
      .delete-btn, .rename-btn {
        top: auto;
        right: 10px;
        position: static;
        margin-right: 5px;
      }
      .file-item button {
        display: inline-block;
        margin-top: 5px;
      }
    }
    .disabled-btn {
      background: #444 !important;
      color: #888 !important;
      cursor: not-allowed !important;
      opacity: 0.6;
    }
    .public-private-btns {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .public-private-btns button {
      flex: 1;
      font-weight: normal;
      background: #555;
      color: white;
      cursor: pointer;
      border-radius: 6px;
      padding: 8px 0;
      transition: background 0.2s ease;
    }
    .public-private-btns button:hover {
      background: #0ea5e9;
    }
    .public-private-btns button.disabled {
      background: #444 !important;
      cursor: not-allowed !important;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ByteCrate</h2>

    <div id="auth-container">
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button id="login-btn">Log In</button>
      <button id="signup-btn">Sign Up</button>
      <button id="reset-password-btn" style="background:#444;">Forgot Password?</button>
      <p id="auth-message" style="color:#e55353; margin-top: 10px;"></p>
    </div>

    <div id="upload-container" style="display:none;">
      <input type="file" id="fileInput" />
      <button onclick="uploadFile()">â¬† Upload</button>
      <button id="clear-saved-btn" class="disabled-btn">ðŸ—‘ Clear Saved</button>
      <button id="logout-btn">Sign Out</button>
      <div id="fileList"></div>
    </div>
  </div>

<script>
  const client = supabase.createClient(
    'https://thenkydyibcxlcvdgifo.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoZW5reWR5aWJjeGxjdmRnaWZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NzE2MDgsImV4cCI6MjA2NzA0NzYwOH0.fkms-yQx1ODCKczimbapEwxcHahYfb9En-vxX9GzfQo'
  );
  const BUCKET = 'testfiles';

  const authContainer = document.getElementById('auth-container');
  const uploadContainer = document.getElementById('upload-container');
  const authMessage = document.getElementById('auth-message');

  document.getElementById('login-btn').addEventListener('click', async () => {
    authMessage.textContent = '';
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    if (!email || !password) return authMessage.textContent = "Email and password required";
    const { error } = await client.auth.signInWithPassword({ email, password });
    if (error) authMessage.textContent = error.message;
  });

  document.getElementById('signup-btn').addEventListener('click', async () => {
    authMessage.textContent = '';
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    if (!email || !password) return authMessage.textContent = "Email and password required";
    const { error } = await client.auth.signUp({ email, password });
    if (error) authMessage.textContent = error.message;
    else {
      authMessage.style.color = '#0ea5e9';
      authMessage.textContent = "Sign up successful! Please check your email to confirm.";
    }
  });
document.getElementById('reset-password-btn').addEventListener('click', async () => {
  const email = document.getElementById('email').value;
  authMessage.style.color = '#e55353';

  if (!email) {
    authMessage.textContent = 'Please enter your email above first.';
    return;
  }

  const { error } = await client.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.href // Change this to your password reset page if needed
  });

  if (error) {
    authMessage.textContent = error.message;
  } else {
    authMessage.style.color = '#0ea5e9';
    authMessage.textContent = 'Password reset email sent!';
  }
});

  document.getElementById('logout-btn').addEventListener('click', async () => {
    await client.auth.signOut();
  });

  client.auth.onAuthStateChange((event, session) => {
    if (session && session.user) {
      authContainer.style.display = 'none';
      uploadContainer.style.display = 'block';
      loadFiles();
    } else {
      authContainer.style.display = 'block';
      uploadContainer.style.display = 'none';
      authMessage.textContent = '';
    }
  });

  async function uploadFile() {
    const fileInput = document.getElementById('fileInput');
    if (!fileInput.files.length) {
      alert('Please select a file first.');
      return;
    }
    const file = fileInput.files[0];
    const user = client.auth.user();
    if (!user) {
      alert('Please log in first.');
      return;
    }
    // Create a unique filename prefix with user id and timestamp
    const timestamp = Date.now();
    const fileName = `${user.id}_${timestamp}_${file.name}`;

    // Upload the file
    const { error } = await client.storage.from(BUCKET).upload(fileName, file, {
      cacheControl: '3600',
      upsert: false
    });

    if (error) {
      alert('Upload error: ' + error.message);
      return;
    }

    // Insert into 'files' table (your existing table) for metadata & public hashtag links
    const { error: insertError } = await client
      .from('files')
      .insert([{ user_id: user.id, filename: fileName, original_name: file.name }]);

    if (insertError) {
      alert('Database error: ' + insertError.message);
      return;
    }

    fileInput.value = '';
    loadFiles();
  }

  async function loadFiles() {
    const user = client.auth.user();
    if (!user) return;

    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '<p>Loading your files...</p>';

    // Fetch all files for the user from the 'files' table, including public hash links
    const { data, error } = await client
      .from('files')
      .select('id, filename, original_name, public_link')
      .eq('user_id', user.id)
      .order('id', { ascending: false });

    if (error) {
      fileList.innerHTML = `<p>Error loading files: ${error.message}</p>`;
      return;
    }

    if (!data.length) {
      fileList.innerHTML = '<p>No files uploaded yet.</p>';
      return;
    }

    fileList.innerHTML = '';
    for (const file of data) {
      const publicLink = file.public_link;
      const storageUrl = client.storage.from(BUCKET).getPublicUrl(file.filename).data.publicUrl;
      const ext = file.filename.split('.').pop().toLowerCase();
      const isImage = ['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp', 'svg'].includes(ext);
      const isVideo = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv'].includes(ext);

      const div = document.createElement('div');
      div.className = 'file-item';

      div.innerHTML = `
        <strong>${file.original_name}</strong><br>
        <small>Raw Link: <a href="${storageUrl}" target="_blank">${storageUrl}</a></small><br>
        ${isImage ? `<img src="${storageUrl}" alt="${file.original_name}" />` : ''}
        ${isVideo ? `<video controls src="${storageUrl}"></video>` : ''}
        <button class="delete-btn" data-id="${file.id}">Delete</button>
        <button class="rename-btn" data-id="${file.id}">Rename</button>
        <div class="public-private-btns">
          <button class="make-public-btn" data-id="${file.id}" ${publicLink ? 'disabled class="disabled"' : ''}>Make Public</button>
          <button class="make-private-btn" data-id="${file.id}" ${!publicLink ? 'disabled class="disabled"' : ''}>Make Private</button>
        </div>
        ${publicLink ? `<small>Public Link: <a href="https://yourdomain.com/#p${publicLink}" target="_blank">https://yourdomain.com/#p${publicLink}</a></small>` : ''}
      `;

      fileList.appendChild(div);
    }

    attachFileButtons();
  }

  function attachFileButtons() {
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('Delete this file? This is irreversible.')) return;

        // Get file info first to delete from storage
        const { data, error } = await client.from('files').select('filename').eq('id', id).single();
        if (error || !data) {
          alert('File not found.');
          return;
        }

        // Delete from storage
        const { error: delStorageError } = await client.storage.from(BUCKET).remove([data.filename]);
        if (delStorageError) {
          alert('Storage deletion error: ' + delStorageError.message);
          return;
        }

        // Delete from DB
        const { error: delDbError } = await client.from('files').delete().eq('id', id);
        if (delDbError) {
          alert('Database deletion error: ' + delDbError.message);
          return;
        }

        loadFiles();
      };
    });

    document.querySelectorAll('.rename-btn').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        const newName = prompt('Enter new name (including extension):');
        if (!newName) return;

        // Validate new name (basic)
        if (!newName.includes('.')) {
          alert('Please include a file extension, e.g. "photo.jpg"');
          return;
        }

        // Get file info first
        const { data, error } = await client.from('files').select('filename').eq('id', id).single();
        if (error || !data) {
          alert('File not found.');
          return;
        }

        // Rename in storage: Supabase Storage does not support rename, so we must copy then delete
        const oldFilename = data.filename;
        const user = client.auth.user();
        if (!user) {
          alert('Please log in again.');
          return;
        }
        const timestamp = Date.now();
        const newFilename = `${user.id}_${timestamp}_${newName}`;

        // Download file from storage
        const { data: fileData, error: downloadError } = await client.storage.from(BUCKET).download(oldFilename);
        if (downloadError) {
          alert('Download error: ' + downloadError.message);
          return;
        }
        const fileBlob = await fileData.blob();

        // Upload with new filename
        const { error: uploadError } = await client.storage.from(BUCKET).upload(newFilename, fileBlob);
        if (uploadError) {
          alert('Upload error: ' + uploadError.message);
          return;
        }

        // Delete old file
        const { error: deleteOldError } = await client.storage.from(BUCKET).remove([oldFilename]);
        if (deleteOldError) {
          alert('Old file deletion error: ' + deleteOldError.message);
          return;
        }

        // Update DB record with new filename and original_name
        const { error: updateError } = await client
          .from('files')
          .update({ filename: newFilename, original_name: newName })
          .eq('id', id);

        if (updateError) {
          alert('Database update error: ' + updateError.message);
          return;
        }

        loadFiles();
      };
    });

    document.querySelectorAll('.make-public-btn').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        btn.disabled = true;

        // Generate a random 6-character hash as public_link
        const hash = generateRandomHash(6);

        // Save the public_link to DB
        const { error } = await client.from('files').update({ public_link: hash }).eq('id', id);

        if (error) {
          alert('Error making public: ' + error.message);
          btn.disabled = false;
          return;
        }

        loadFiles();
      };
    });

    document.querySelectorAll('.make-private-btn').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        btn.disabled = true;

        // Remove the public_link from DB
        const { error } = await client.from('files').update({ public_link: null }).eq('id', id);

        if (error) {
          alert('Error making private: ' + error.message);
          btn.disabled = false;
          return;
        }

        loadFiles();
      };
    });
  }

  function generateRandomHash(length) {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i=0; i < length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  document.getElementById('clear-saved-btn').addEventListener('click', () => {
    if (!confirm('Clear all your saved files metadata? This does NOT delete files from storage.')) return;
    const user = client.auth.user();
    if (!user) return;
    client.from('files').delete().eq('user_id', user.id).then(() => loadFiles());
  });
</script>
</body>
</html>