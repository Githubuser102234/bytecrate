<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>My Cloud Storage</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f0f0f0;
    }
    input, button {
      padding: 10px;
      margin: 5px;
    }
    #file-list img, #file-list video {
      max-width: 200px;
      max-height: 150px;
      margin: 10px;
      display: block;
    }
    .file-item {
      background: white;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
    }
    .hidden { display: none; }
  </style>
</head>
<body>

<h2>☁️ My Cloud Storage</h2>

<div id="auth-section">
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
</div>

<div id="main-section" class="hidden">
  <p>Welcome, <span id="user-email"></span>! <button id="logoutBtn">Logout</button></p>
  <input type="file" id="fileInput" />
  <button id="uploadBtn">Upload</button>

  <h3>Your Files:</h3>
  <div id="file-list"></div>
</div>

<!-- Load Supabase library FIRST -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabase = supabase.createClient(
    "https://sgtfjntptdxgrcqkftn.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNndGZqbnRwdGR4Z3JjcXFrZnRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyNDE3NzksImV4cCI6MjA2NjgxNzc3OX0.6u77xHcSVwShF2YDtaPMuo9NIw035v8QczoNAqqDVVk"
  );

  const authSection = document.getElementById("auth-section");
  const mainSection = document.getElementById("main-section");
  const fileList = document.getElementById("file-list");
  const userEmailSpan = document.getElementById("user-email");

  // Auth functions
  async function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) alert("Login failed: " + error.message);
    else location.reload();
  }

  async function signup() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) alert("Signup failed: " + error.message);
    else alert("Check your email to confirm sign up.");
  }

  async function logout() {
    await supabase.auth.signOut();
    location.reload();
  }

  async function uploadFile() {
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];
    if (!file) return alert("Please select a file.");

    const user = (await supabase.auth.getUser()).data.user;
    const path = `${user.id}/${Date.now()}_${file.name}`;

    const { error: uploadError } = await supabase.storage.from("uploads").upload(path, file);
    if (uploadError) return alert("Upload failed: " + uploadError.message);

    const { data: { publicUrl } } = supabase.storage.from("uploads").getPublicUrl(path);

    await supabase.from("files").insert({
      user_id: user.id,
      filename: file.name,
      url: publicUrl
    });

    fileInput.value = "";
    loadFiles();
  }

  async function loadFiles() {
    const user = (await supabase.auth.getUser()).data.user;
    const { data: files, error } = await supabase
      .from("files")
      .select("*")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false });

    if (error) return alert("Failed to load files: " + error.message);

    fileList.innerHTML = "";
    for (const file of files) {
      const container = document.createElement("div");
      container.className = "file-item";

      const isImage = file.url.match(/\.(jpg|jpeg|png|gif)$/i);
      const isVideo = file.url.match(/\.(mp4|webm|ogg)$/i);

      if (isImage) {
        const img = document.createElement("img");
        img.src = file.url;
        container.appendChild(img);
      } else if (isVideo) {
        const vid = document.createElement("video");
        vid.src = file.url;
        vid.controls = true;
        container.appendChild(vid);
      } else {
        const link = document.createElement("a");
        link.href = file.url;
        link.textContent = file.filename;
        link.target = "_blank";
        container.appendChild(link);
      }

      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.onclick = async () => {
        const path = file.url.split("/uploads/")[1];
        await supabase.storage.from("uploads").remove([path]);
        await supabase.from("files").delete().eq("id", file.id);
        loadFiles();
      };
      container.appendChild(delBtn);

      fileList.appendChild(container);
    }
  }

  // Handle auth state
  supabase.auth.onAuthStateChange((event, session) => {
    if (session && session.user) {
      authSection.classList.add("hidden");
      mainSection.classList.remove("hidden");
      userEmailSpan.textContent = session.user.email;
      loadFiles();
    } else {
      authSection.classList.remove("hidden");
      mainSection.classList.add("hidden");
    }
  });

  // Initial session check
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session && session.user) {
      authSection.classList.add("hidden");
      mainSection.classList.remove("hidden");
      userEmailSpan.textContent = session.user.email;
      loadFiles();
    }
  })();

  // Attach buttons after DOM is loaded
  document.getElementById("loginBtn").addEventListener("click", login);
  document.getElementById("signupBtn").addEventListener("click", signup);
  document.getElementById("logoutBtn").addEventListener("click", logout);
  document.getElementById("uploadBtn").addEventListener("click", uploadFile);
</script>
</body>
</html>